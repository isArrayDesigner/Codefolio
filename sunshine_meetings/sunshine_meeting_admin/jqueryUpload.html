<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons">
<link rel="stylesheet" href="https://unpkg.com/bootstrap-material-design@4.1.1/dist/css/bootstrap-material-design.min.css" integrity="sha384-wXznGJNEXNG1NFsbm0ugrLFMQPWswR3lds2VeinahP8N0zJw9VWSopbjv2x7WCvX" crossorigin="anonymous">
<style>
#addFileButton{
	background-image:none;
}
</style>
<body>
<!-- Modal -->
<div class="modal fade" id="successSubmit" tabindex="-1" role="dialog" aria-labelledby="successSubmitTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                    <!--<h5 class="modal-title" id="successSubmitLongTitle">Modal title</h5>
<button type="button" class="close" data-dismiss="modal" aria-label="Close">
<span aria-hidden="true">&times;</span>
</button>-->
            </div>
            <div class="modal-body text-center">
                    <!-- injected modal success message-->
            </div>
            <div class="modal-footer justify-content-center pb-2">
			<button type="button" class="btn btn-secondary border" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="container">
	<div class="row justify-content-start">
		<div class="col-9 p-5 border">
				<h2 class="text-center">DOCUMENT UPLOAD FORM</h2>
		<p class="text-center mb-4 font-weight-bold">Asterisks(<font color="red">*</font>) indicate required fields.</p>
		<div>
			<label for="displayName">Upload File <font color="red">*</font></label>
			<input class="py-2 form-control border-0" id="getFile" type="file" required><br />
		</div>
		<div>
			<label for="displayName">File Name <font color="red">*</font></label>  
			<input class="py-2 form-control border-0" id="displayName" type="text" value="" placeholder="Enter unique name" required><br />
			</div>	
			<!--<input class="py-2 form-control" id="itemID" type="number" value="" placeholder="Meeting ID"><br />-->
				<div id="meetingId" class="my-2">   
					<label for="itemID">Meeting ID <font color="red">*</font></label>
						<select class="py-2 custom-select" id="itemID" required>
							<option value="" disabled selected>Choose Meeting ID</option>
						</select>
				</div>
			 	<div class="form-check my-4">
				  <input class="form-check-input" id="ada" type="checkbox" required>
				  <label class="form-check-label" for="adaCompliance">
				           <strong>ADA Compliance<font color="red">*</font></strong><br/> I affirm that the uploaded document to be made available to the public meets ADA requirements.
				  </label>
				</div>
				<div class="form-check my-4">
				  <input class="form-check-input" id="confData" type="checkbox" required>
				  <label class="form-check-label" for="confidentialData">
			               <strong>Confidential Data<font color="red">*</font></strong><br/> I affirm that the uploaded document to be made available to the public does not contain any sensitive/confidential data.
				  </label>
				</div>
				<input class="py-2 mx-0 form-control submitButton" id="addFileButton" type="button" value="Submit"/>
		</div>
	</div>
	<div class="col-9 p-5">
	<div class="row justify-content-center"><a href="/pages/default.aspx" class="btn btn-warning">< Return to Home Page</a></div>
	</div>

</div>
  


<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<script src="https://unpkg.com/popper.js@1.12.6/dist/umd/popper.js" integrity="sha384-fA23ZRQ3G/J53mElWqVJEGJzU0sTs+SvzG8fXVWP+kJQ1lwFAOkcUOysnlKJC33U" crossorigin="anonymous"></script>
<script src="https://unpkg.com/bootstrap-material-design@4.1.1/dist/js/bootstrap-material-design.js" integrity="sha384-CauSuKpEqAFajSpkdjv3z9t8E7RlpJ1UP0lKM/+NdtSarroVKu069AlsRPKkFBz9" crossorigin="anonymous"></script>
<!--<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.0/jquery-ui.min.js"></script>-->
<script src="https://kit.fontawesome.com/845d470415.js" crossorigin="anonymous"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script> 
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.SPServices/0.7.2/jquery.SPServices-0.7.2.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.1/jquery.validate.min.js"></script>
<script type="text/javascript" src="https://polyfill.io/v3/polyfill.min.js?features=default%2Ces2015%2Ces2016%2Ces2017%2Ces2018%2Ces5%2Ces6%2Ces7"></script>


<script>

'use strict';

$('#s4-titlerow, #titleAreaBox, #titleAreaRow, #siteIcon, #sideNavBox, #DeltaPageStatusBar,#s4-ribbonrow').hide()
//$('#s4-titlerow').hide()
//$('#contentBox').css('margin','0 50px')

$(document).ready(function () {
  if (_spPageContextInfo.userId) {
    $.ajax({
      url: "/_api/web/lists/GetByTitle('Sunshine Form')/items?$top=1000",
      method: 'GET',
      headers: {
        Accept: 'application/json; odata=verbose'
      },

      success: function (data) {
        let meetingResults = data.d.results
        console.log(meetingResults)

        let meetingIDs = []
        for (let i = 0; i < meetingResults.length; i++) {
          let meetingItems = meetingResults[i]
          meetingIDs.push(meetingItems.MeetingID)
        }
        //meetingIDs.sort()
        meetingIDs.reverse()
        $.each(meetingIDs, function (ind, ids) {
          $('#itemID').append(
            $('<option value="' + ids + '">' + ids + '</option>')
          )
        })
      }
    })

    // Check for FileReader API (HTML5) support.
    if (!window.FileReader) {
      alert('This browser does not support the FileReader API.')
    }

    let required = $('[required]')
    let requireditems = required.length
    let valid = false

    function validateForm () {
      requireditems = required.length
      for (let i = 0; i <= required.length; i++) {
        let requiredItem = required[i]
        //console.log(requireditems +' '+ requiredItem +' '+ requiredItem.value +' ' + requiredItem.value.length)
        if (requireditems > 0) {
          if (
            requiredItem.value.length == 0 ||
            ($(requiredItem).attr('type') == 'checkbox' &&
              requiredItem.checked == false)
          ) {
            $(requiredItem)
              .parent()
              .append(
                '<div class="alert alert-warning formAlerts mt-1" role="alert">This field is required.</div>'
              )
            $('.generalAlert').removeClass('d-none')
          } else {
            requireditems--
          }
        } else {
          valid = true
        }
      }
    }
    // Upload the file.
    // You can upload files up to 2 GB with the REST API.
    function uploadFile () {
      // Define the folder path for this example.
      var serverRelativeUrlToFolder = '/Sunshine Meetings Documents'

      // Get test values from the file input and text input page controls.
      var fileInput = $('#getFile')
      var adaConfirm = $('#ada').val() == 'on' ? 'Yes' : 'No'
      var confDataConfirm = $('#confData').val() == 'on' ? 'Yes' : 'No'
      var itemID = $('#itemID').val()
      var newName = $('#displayName').val() + '_' + itemID

      // Get the server URL.
      var serverUrl = _spPageContextInfo.webAbsoluteUrl

      // Initiate method calls using jQuery promises.
      // Get the local file as an array buffer.
      var getFile = getFileBuffer()
      getFile.done(function (arrayBuffer) {
        // Add the file to the SharePoint folder.
        var addFile = addFileToFolder(arrayBuffer)
        addFile.done(function (file, status, xhr) {
          // Get the list item that corresponds to the uploaded file.
          var getItem = getListItem(file.d.ListItemAllFields.__deferred.uri)
          getItem.done(function (listItem, status, xhr) {
            // Change the display name and title of the list item.
            var changeItem = updateListItem(listItem.d.__metadata)
            changeItem.done(function (data, status, xhr) {
              //alert('file uploaded and updated')
              window.location.href =
                'https://sunshineauthor/Pages/uploadSuccess.aspx'
            })
            changeItem.fail(onError)
          })
          getItem.fail(onError)
        })
        addFile.fail(onError)
      })
      getFile.fail(onError)

      // Get the local file as an array buffer.
      function getFileBuffer () {
        var deferred = $.Deferred()
        var reader = new FileReader()
        reader.onloadend = function (e) {
          deferred.resolve(e.target.result)
        }
        reader.onerror = function (e) {
          deferred.reject(e.target.error)
        }
        reader.readAsArrayBuffer(fileInput[0].files[0])
        return deferred.promise()
      }

      // Add the file to the file collection in the Shared Documents folder.
      function addFileToFolder (arrayBuffer) {
        // Get the file name from the file input control on the page.
        var parts = fileInput[0].value.split('\\')
        var fileName = parts[parts.length - 1]

        // Construct the endpoint.
        var fileCollectionEndpoint = String.format(
          "{0}/_api/web/getfolderbyserverrelativeurl('{1}')/files" +
            "/add(overwrite=true, url='{2}')",
          serverUrl,
          serverRelativeUrlToFolder,
          fileName
        )

        // Send the request and return the response.
        // This call returns the SharePoint file.
        return $.ajax({
          url: fileCollectionEndpoint,
          type: 'POST',
          data: arrayBuffer,
          processData: false,
          headers: {
            accept: 'application/json;odata=verbose',
            'X-RequestDigest': $('#__REQUESTDIGEST').val(),
            'content-length': arrayBuffer.byteLength
          }
        })
      }

      // Get the list item that corresponds to the file by calling the file's ListItemAllFields property.
      function getListItem (fileListItemUri) {
        // Send the request and return the response.
        return $.ajax({
          url: fileListItemUri,
          type: 'GET',
          headers: { accept: 'application/json;odata=verbose' }
        })
      }

      // Change the display name and title of the list item.
      function updateListItem (itemMetadata) {
        // Define the list item changes. Use the FileLeafRef property to change the display name.
        // For simplicity, also use the name as the title.
        // The example gets the list item type from the item's metadata, but you can also get it from the
        // ListItemEntityTypeFullName property of the list.
        var body = String.format(
          "{{'__metadata':{{'type':'{0}'}},'FileLeafRef':'{1}','Title':'{2}', 'ADA_x0020_Compliance':'{3}', 'Confidential_x0020_Data':'{4}', 'ItemID':'{5}'}}",
          itemMetadata.type,
          newName,
          newName,
          adaConfirm,
          confDataConfirm,
          itemID
        )

        // Send the request and return the promise.
        // This call does not return response content from the server.
        return $.ajax({
          url: itemMetadata.uri,
          type: 'POST',
          data: body,
          headers: {
            'X-RequestDigest': $('#__REQUESTDIGEST').val(),
            'content-type': 'application/json;odata=verbose',
            //'content-length': body.length,
            'IF-MATCH': itemMetadata.etag,
            'X-HTTP-Method': 'MERGE'
          }
        })
      }
    }
    function submitUpload () {
      $('.formAlerts').remove()
      validateForm()
      console.log(valid)
      if (valid == true) {
        $('.submitButton').attr('value', 'Submitting...')
        $('.submitButton').attr('disabled', 'disabled')
        uploadFile()
      } else {
        alert('Please fill in all required fields')
      }
    }
    $('#addFileButton').on('click', function () {
      submitUpload()
    })

    // Display error messages.
    function onError (error) {
      console.log(error.responseText)
      $('#successSubmit').modal()
      $('#successSubmit .modal-body').append(
        '<h5>The <strong>file name</strong> you have chosen is already in use, please enter another and resubmit.</h5>'
      )
      $('.submitButton').attr('value', 'Submit')
      $('.submitButton').removeAttr('disabled')
    }
  } else {
    window.location.href =
      'https://sunshineauthor/_layouts/15/Authenticate.aspx?Source=%2FPages%2FdocumentUpload%2Easpx'
  }
})
</script>
</body>
